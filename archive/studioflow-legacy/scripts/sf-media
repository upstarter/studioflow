#!/usr/bin/env python3
"""
sf-media - Intelligent media organization for DaVinci Resolve
Analyzes and auto-categorizes footage based on content
"""

import sys
import os
import json
import subprocess
from pathlib import Path
from datetime import datetime

sys.path.insert(0, '/mnt/projects/studioflow')
from sfcore import Project, JsonStream, CliHelper

class MediaOrganizer:
    def __init__(self):
        self.json = JsonStream()

    def analyze_clips(self, source_dir):
        """Analyze clips and categorize by type"""
        source = Path(source_dir)
        clips = list(source.glob("**/*.mp4")) + list(source.glob("**/*.MP4"))

        categories = {
            "a_roll": [],
            "b_roll": [],
            "screen": [],
            "thumbnails": []
        }

        for clip in clips:
            # Get clip info using ffprobe
            duration = self._get_duration(clip)
            resolution = self._get_resolution(clip)

            # Categorization logic
            if "SCREEN" in clip.name.upper():
                categories["screen"].append(clip)
            elif duration > 60:  # Longer clips likely A-roll
                categories["a_roll"].append(clip)
            elif duration < 10:  # Very short clips
                categories["thumbnails"].append(clip)
            else:
                categories["b_roll"].append(clip)

            self.json.emit({
                "event": "clip_analyzed",
                "file": str(clip.name),
                "duration": duration,
                "resolution": resolution
            })

        return categories

    def _get_duration(self, file):
        """Get clip duration in seconds"""
        try:
            cmd = [
                "ffprobe", "-v", "error",
                "-show_entries", "format=duration",
                "-of", "default=noprint_wrappers=1:nokey=1",
                str(file)
            ]
            result = subprocess.run(cmd, capture_output=True, text=True)
            return float(result.stdout.strip())
        except:
            return 0

    def _get_resolution(self, file):
        """Get clip resolution"""
        try:
            cmd = [
                "ffprobe", "-v", "error",
                "-select_streams", "v:0",
                "-show_entries", "stream=width,height",
                "-of", "csv=p=0",
                str(file)
            ]
            result = subprocess.run(cmd, capture_output=True, text=True)
            width, height = result.stdout.strip().split(',')
            return f"{width}x{height}"
        except:
            return "unknown"

    def create_resolve_script(self, categories, project_path):
        """Generate Resolve Python script to organize media"""
        script = '''#!/usr/bin/env python
# Auto-generated by sf-media
# Run this in DaVinci Resolve Console

import DaVinciResolveScript as dvr

resolve = dvr.scriptapp("Resolve")
pm = resolve.GetProjectManager()
project = pm.GetCurrentProject()
mp = project.GetMediaPool()
root = mp.GetRootFolder()

# Create bin structure
print("Creating bin structure...")
bins = {}

# Main bins
footage_bin = mp.AddSubFolder(root, "01_FOOTAGE")
audio_bin = mp.AddSubFolder(root, "02_AUDIO")
graphics_bin = mp.AddSubFolder(root, "03_GRAPHICS")

# Sub bins
bins['a_roll'] = mp.AddSubFolder(footage_bin, "A_ROLL")
bins['b_roll'] = mp.AddSubFolder(footage_bin, "B_ROLL")
bins['screen'] = mp.AddSubFolder(footage_bin, "SCREEN")

# Import categorized media
print("Importing media...")
'''

        # Add import commands for each category
        for category, clips in categories.items():
            if clips and category != "thumbnails":
                script += f"\n# Import {category.upper()}\n"
                script += f"mp.SetCurrentFolder(bins.get('{category}', bins['b_roll']))\n"
                script += f"clips_{category} = [\n"
                for clip in clips:
                    script += f'    r"{clip}",\n'
                script += "]\n"
                script += f"mp.ImportMedia(clips_{category})\n"

        script += '\nprint("âœ… Media organization complete!")\n'

        # Save script
        script_path = Path(project_path) / ".studioflow" / "resolve" / "organize_media.py"
        script_path.parent.mkdir(parents=True, exist_ok=True)
        script_path.write_text(script)

        return script_path

    def organize(self, source_dir, project_path=None):
        """Main organization workflow"""
        print(f"ðŸŽ¬ Analyzing media in {source_dir}")

        # Analyze clips
        categories = self.analyze_clips(source_dir)

        # Report findings
        total = sum(len(clips) for clips in categories.values())
        print(f"\nðŸ“Š Analysis Complete:")
        print(f"  Total clips: {total}")
        print(f"  A-Roll: {len(categories['a_roll'])}")
        print(f"  B-Roll: {len(categories['b_roll'])}")
        print(f"  Screen: {len(categories['screen'])}")
        print(f"  Thumbnails: {len(categories['thumbnails'])}")

        # Generate Resolve script if project specified
        if project_path:
            script_path = self.create_resolve_script(categories, project_path)
            print(f"\nâœ… Resolve script created:")
            print(f"  {script_path}")
            print(f"\nðŸ“‹ To use in Resolve:")
            print(f"  1. Open Resolve Console (Workspace â†’ Console)")
            print(f"  2. Copy and paste the script")
            print(f"  3. Press Enter to organize")

        # Emit summary event
        self.json.emit({
            "event": "organization_complete",
            "total_clips": total,
            "categories": {k: len(v) for k, v in categories.items()}
        })

        return categories

def main():
    organizer = MediaOrganizer()

    if len(sys.argv) < 2:
        print("Usage: sf-media <source_dir> [--project <path>]")
        print("\nAnalyze and categorize media for Resolve import")
        print("\nExamples:")
        print("  sf-media /mnt/ingest/Camera/Pool/2025-09/")
        print("  sf-media . --project /mnt/studio/Projects/Episode1")
        sys.exit(1)

    source_dir = sys.argv[1]
    project_path = None

    # Check for project flag
    if "--project" in sys.argv:
        idx = sys.argv.index("--project")
        if idx + 1 < len(sys.argv):
            project_path = sys.argv[idx + 1]

    organizer.organize(source_dir, project_path)

if __name__ == "__main__":
    main()